{% extends "base.html" %}

{% block title %}Vulnerability Scan - NetAudit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-bug"></i> Vulnerability Scan</h2>
        <p class="text-muted">Perform automated vulnerability assessment and security analysis.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Scan Configuration</h5>
            </div>
            <div class="card-body">
                <form id="vulnScanForm">
                    <div class="mb-3">
                        <label for="targetIp" class="form-label">Target IP Address</label>
                        <input type="text" class="form-control" id="targetIp" value="192.168.1.5" required>
                        <div class="form-text">Enter the IP address to scan for vulnerabilities</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scanMode" class="form-label">Scan Mode</label>
                        <select class="form-control" id="scanMode">
                            <option value="auto">Auto Scan (Recommended)</option>
                            <option value="custom">Custom Vulnerability Search</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="keywordDiv" style="display: none;">
                        <label for="keyword" class="form-label">Vulnerability Keyword</label>
                        <input type="text" class="form-control" id="keyword" placeholder="e.g., SSH, HTTP, FTP">
                        <div class="form-text">Search for specific vulnerability types</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="permission" required>
                        <label class="form-check-label" for="permission">
                            I have permission to scan this target
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-play"></i> Start Vulnerability Scan
                    </button>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-exclamation-triangle"></i> Warning</h6>
            </div>
            <div class="card-body">
                <small>
                    <p class="text-warning mb-2"><strong>Caution:</strong> Vulnerability scans can be intrusive and may trigger security alerts.</p>
                    <ul class="mb-0">
                        <li>Only scan systems you own</li>
                        <li>Obtain proper authorization</li>
                        <li>Be aware of potential service disruption</li>
                        <li>Follow responsible disclosure practices</li>
                    </ul>
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-shield-alt"></i> Vulnerability Results</h5>
                <div id="scanStats" class="badge bg-secondary">Ready</div>
            </div>
            <div class="card-body">
                <div id="resultsContainer" class="results-container" style="display: none;">
                    <div id="resultsContent"></div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-success" id="downloadPdfBtn">
                            <i class="fas fa-file-pdf"></i> Download PDF Report
                        </button>
                    </div>
                </div>
                
                <div id="noResults" class="text-center text-muted py-5">
                    <i class="fas fa-shield-alt fa-3x mb-3"></i>
                    <h5>No vulnerability scan results yet</h5>
                    <p>Configure your scan parameters and click "Start Vulnerability Scan" to begin.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let scanResults = [];
let currentTarget = '';

document.getElementById('scanMode').addEventListener('change', function() {
    const keywordDiv = document.getElementById('keywordDiv');
    if (this.value === 'custom') {
        keywordDiv.style.display = 'block';
        document.getElementById('keyword').required = true;
    } else {
        keywordDiv.style.display = 'none';
        document.getElementById('keyword').required = false;
    }
});

document.getElementById('vulnScanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!document.getElementById('permission').checked) {
        showAlert('You must confirm you have permission before scanning.', 'danger');
        return;
    }
    
    const targetIp = document.getElementById('targetIp').value;
    const scanMode = document.getElementById('scanMode').value;
    const keyword = document.getElementById('keyword').value;
    currentTarget = targetIp;
    
    showLoading();
    document.getElementById('scanStats').textContent = 'Scanning...';
    document.getElementById('scanStats').className = 'badge bg-warning';
    
    fetch('/api/vulnerability_scan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ip: targetIp,
            mode: scanMode,
            keyword: keyword
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            scanResults = data.data;
            displayResults(data.data);
            
            if (Array.isArray(data.data) && data.data.length > 0) {
                document.getElementById('scanStats').textContent = `${data.data.length} vulnerabilities found`;
                document.getElementById('scanStats').className = 'badge bg-danger';
            } else if (data.data.error) {
                document.getElementById('scanStats').textContent = 'No vulnerabilities found';
                document.getElementById('scanStats').className = 'badge bg-success';
            } else {
                document.getElementById('scanStats').textContent = 'Scan completed';
                document.getElementById('scanStats').className = 'badge bg-info';
            }
        } else {
            showAlert('Scan failed: ' + data.error, 'danger');
            document.getElementById('scanStats').textContent = 'Scan failed';
            document.getElementById('scanStats').className = 'badge bg-danger';
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showAlert('Network error: ' + error.message, 'danger');
        document.getElementById('scanStats').textContent = 'Error';
        document.getElementById('scanStats').className = 'badge bg-danger';
    });
});

function displayResults(results) {
    const content = document.getElementById('resultsContent');
    content.innerHTML = '';
    
    if (!results || (Array.isArray(results) && results.length === 0) || results.error) {
        document.getElementById('noResults').style.display = 'block';
        document.getElementById('resultsContainer').style.display = 'none';
        
        if (results && results.error) {
            showAlert(results.error, 'info');
        }
        return;
    }
    
    document.getElementById('noResults').style.display = 'none';
    document.getElementById('resultsContainer').style.display = 'block';
    
    if (Array.isArray(results)) {
        results.forEach((vuln, index) => {
            const card = document.createElement('div');
            card.className = 'card mb-3 border-danger';
            card.innerHTML = `
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="fas fa-bug"></i> Vulnerability #${index + 1}: ${vuln.vuln}</h6>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded"><code>${JSON.stringify(vuln.result, null, 2)}</code></pre>
                </div>
            `;
            content.appendChild(card);
        });
    } else {
        const card = document.createElement('div');
        card.className = 'card border-info';
        card.innerHTML = `
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Scan Results</h6>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 rounded"><code>${JSON.stringify(results, null, 2)}</code></pre>
            </div>
        `;
        content.appendChild(card);
    }
}

// Download PDF Report
document.getElementById('downloadPdfBtn').addEventListener('click', function() {
    if (!scanResults || (Array.isArray(scanResults) && scanResults.length === 0)) {
        showAlert('No results to download', 'warning');
        return;
    }
    
    const scanMode = document.getElementById('scanMode').value;
    const title = `${scanMode === 'auto' ? 'Auto' : 'Custom'} Vulnerability Scan Report - ${currentTarget}`;
    const filename = `vulnerability_scan_${currentTarget.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.pdf`;
    
    downloadReport(scanResults, title, filename);
});

// Pre-fill IP from URL parameters if available
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('ip')) {
    document.getElementById('targetIp').value = urlParams.get('ip');
}
</script>
{% endblock %} 