{% extends "base.html" %}

{% block title %}DNS Audit - NetAudit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-globe"></i> DNS Audit</h2>
        <p class="text-muted">Perform DNS lookups and analyze domain name resolution.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Audit Configuration</h5>
            </div>
            <div class="card-body">
                <form id="dnsAuditForm">
                    <div class="mb-3">
                        <label for="domain" class="form-label">Domain Name</label>
                        <input type="text" class="form-control" id="domain" value="example.com" required>
                        <div class="form-text">Enter the domain name to audit (e.g., google.com)</div>
                    </div>
                    
                    <button type="submit" class="btn btn-info w-100">
                        <i class="fas fa-play"></i> Run DNS Audit
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> DNS Records</h5>
                <div id="scanStats" class="badge bg-secondary">Ready</div>
            </div>
            <div class="card-body">
                <div id="resultsContainer" style="display: none;">
                    <div id="recordsList"></div>
                    
                    <div class="mt-3">
                        <button class="btn btn-success" id="downloadPdfBtn">
                            <i class="fas fa-file-pdf"></i> Download PDF Report
                        </button>
                    </div>
                </div>
                
                <div id="noResults" class="text-center text-muted py-5">
                    <i class="fas fa-globe fa-3x mb-3"></i>
                    <h5>No DNS records yet</h5>
                    <p>Enter a domain name and click "Run DNS Audit" to begin.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> DNS Audit Information</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Record Types Checked</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> A Records (IPv4 addresses)</li>
                            <li><i class="fas fa-info text-info"></i> Additional record types can be added</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Common Use Cases</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-search text-primary"></i> Domain reconnaissance</li>
                            <li><i class="fas fa-shield-alt text-success"></i> Security assessment</li>
                            <li><i class="fas fa-network-wired text-info"></i> Infrastructure mapping</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let auditResults = [];
let currentDomain = '';

document.getElementById('dnsAuditForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const domain = document.getElementById('domain').value;
    currentDomain = domain;
    
    showLoading();
    document.getElementById('scanStats').textContent = 'Auditing...';
    document.getElementById('scanStats').className = 'badge bg-warning';
    
    fetch('/api/dns_audit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            domain: domain
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            auditResults = data.data;
            displayResults(data.data);
            document.getElementById('scanStats').textContent = `${data.data.length} records found`;
            document.getElementById('scanStats').className = 'badge bg-success';
        } else {
            showAlert('DNS audit failed: ' + data.error, 'danger');
            document.getElementById('scanStats').textContent = 'Audit failed';
            document.getElementById('scanStats').className = 'badge bg-danger';
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showAlert('Network error: ' + error.message, 'danger');
        document.getElementById('scanStats').textContent = 'Error';
        document.getElementById('scanStats').className = 'badge bg-danger';
    });
});

function displayResults(results) {
    const recordsList = document.getElementById('recordsList');
    recordsList.innerHTML = '';
    
    if (!results || results.length === 0) {
        document.getElementById('noResults').style.display = 'block';
        document.getElementById('resultsContainer').style.display = 'none';
        return;
    }
    
    document.getElementById('noResults').style.display = 'none';
    document.getElementById('resultsContainer').style.display = 'block';
    
    results.forEach((record, index) => {
        const isError = record.includes('DNS lookup failed');
        const alertClass = isError ? 'alert-danger' : 'alert-success';
        const icon = isError ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
        
        const recordDiv = document.createElement('div');
        recordDiv.className = `alert ${alertClass}`;
        recordDiv.innerHTML = `
            <h6><i class="${icon}"></i> Record ${index + 1}:</h6>
            <code>${record}</code>
        `;
        recordsList.appendChild(recordDiv);
    });
}

// Download PDF Report
document.getElementById('downloadPdfBtn').addEventListener('click', function() {
    if (auditResults.length === 0) {
        showAlert('No results to download', 'warning');
        return;
    }
    
    const title = `DNS Audit Report - ${currentDomain}`;
    const filename = `dns_audit_${currentDomain.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.pdf`;
    
    downloadReport(auditResults, title, filename);
});
</script>
{% endblock %} 