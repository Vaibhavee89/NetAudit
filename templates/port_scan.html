{% extends "base.html" %}

{% block title %}Port Scan - NetAudit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-door-open"></i> Port & Service Scan</h2>
        <p class="text-muted">Scan for open ports and identify running services on target hosts.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Scan Configuration</h5>
            </div>
            <div class="card-body">
                <form id="portScanForm">
                    <div class="mb-3">
                        <label for="targetIp" class="form-label">Target IP Address</label>
                        <input type="text" class="form-control" id="targetIp" value="192.168.1.1" required>
                        <div class="form-text">Enter the IP address to scan</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="permission" required>
                        <label class="form-check-label" for="permission">
                            I have permission to scan this host
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-play"></i> Start Port Scan
                    </button>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> Scan Information</h6>
            </div>
            <div class="card-body">
                <small>
                    <p><strong>Scan Type:</strong> TCP SYN Scan with Service Detection</p>
                    <p><strong>Port Range:</strong> 1-65535 (All ports)</p>
                    <p><strong>Timing:</strong> Aggressive (-T4)</p>
                    <p class="mb-0"><strong>Note:</strong> This scan may take several minutes to complete.</p>
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Port Scan Results</h5>
                <div id="scanStats" class="badge bg-secondary">Ready</div>
            </div>
            <div class="card-body">
                <div id="resultsContainer" class="results-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Port</th>
                                    <th>State</th>
                                    <th>Service</th>
                                    <th>Product</th>
                                    <th>Version</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-success" id="downloadPdfBtn">
                            <i class="fas fa-file-pdf"></i> Download PDF Report
                        </button>
                        <button class="btn btn-danger" id="vulnScanBtn">
                            <i class="fas fa-bug"></i> Vulnerability Scan
                        </button>
                    </div>
                </div>
                
                <div id="noResults" class="text-center text-muted py-5">
                    <i class="fas fa-door-closed fa-3x mb-3"></i>
                    <h5>No scan results yet</h5>
                    <p>Enter a target IP and click "Start Port Scan" to begin.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let scanResults = [];
let currentTarget = '';

document.getElementById('portScanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!document.getElementById('permission').checked) {
        showAlert('You must confirm you have permission before scanning.', 'danger');
        return;
    }
    
    const targetIp = document.getElementById('targetIp').value;
    currentTarget = targetIp;
    
    showLoading();
    document.getElementById('scanStats').textContent = 'Scanning...';
    document.getElementById('scanStats').className = 'badge bg-warning';
    
    fetch('/api/port_scan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ip: targetIp
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            scanResults = data.data;
            if (data.data.error) {
                showAlert('Scan error: ' + data.data.error, 'warning');
                document.getElementById('scanStats').textContent = 'Error';
                document.getElementById('scanStats').className = 'badge bg-warning';
            } else {
                displayResults(data.data.ports);
                document.getElementById('scanStats').textContent = `${data.data.ports.length} ports found`;
                document.getElementById('scanStats').className = 'badge bg-success';
            }
        } else {
            showAlert('Scan failed: ' + data.error, 'danger');
            document.getElementById('scanStats').textContent = 'Scan failed';
            document.getElementById('scanStats').className = 'badge bg-danger';
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showAlert('Network error: ' + error.message, 'danger');
        document.getElementById('scanStats').textContent = 'Error';
        document.getElementById('scanStats').className = 'badge bg-danger';
    });
});

function displayResults(results) {
    const tbody = document.getElementById('resultsTableBody');
    tbody.innerHTML = '';
    
    if (!results || !Array.isArray(results) || results.length === 0) {
        document.getElementById('noResults').style.display = 'block';
        document.getElementById('resultsContainer').style.display = 'none';
        return;
    }
    
    document.getElementById('noResults').style.display = 'none';
    document.getElementById('resultsContainer').style.display = 'block';
    
    results.forEach(port => {
        const row = document.createElement('tr');
        const stateClass = port.state === 'open' ? 'success' : port.state === 'closed' ? 'danger' : 'warning';
        
        row.innerHTML = `
            <td><strong>${port.port}</strong></td>
            <td><span class="badge bg-${stateClass}">${port.state}</span></td>
            <td>${port.service || 'Unknown'}</td>
            <td>${port.product || '-'}</td>
            <td>${port.version || '-'}</td>
        `;
        tbody.appendChild(row);
    });
}

// Download PDF Report
document.getElementById('downloadPdfBtn').addEventListener('click', function() {
    if (!scanResults || !scanResults.ports || scanResults.ports.length === 0) {
        showAlert('No results to download', 'warning');
        return;
    }
    
    const title = `Port Scan Report - ${currentTarget}`;
    const filename = `port_scan_${currentTarget.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.pdf`;
    
    downloadReport(scanResults.ports, title, filename);
});

// Vulnerability Scan
document.getElementById('vulnScanBtn').addEventListener('click', function() {
    if (!currentTarget) {
        showAlert('No target IP available', 'warning');
        return;
    }
    
    window.location.href = `/vulnerability_scan?ip=${currentTarget}`;
});

// Pre-fill IP from URL parameters if available
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('ip')) {
    document.getElementById('targetIp').value = urlParams.get('ip');
}
</script>
{% endblock %} 