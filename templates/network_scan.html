{% extends "base.html" %}

{% block title %}Network Scan - NetAudit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-network-wired"></i> Network Scan</h2>
        <p class="text-muted">Discover live hosts on your network using ping sweeps and host discovery techniques.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Scan Configuration</h5>
            </div>
            <div class="card-body">
                <form id="networkScanForm">
                    <div class="mb-3">
                        <label for="subnet" class="form-label">Target Subnet</label>
                        <input type="text" class="form-control" id="subnet" value="192.168.1.0/24" required>
                        <div class="form-text">Enter subnet in CIDR notation (e.g., 192.168.1.0/24)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scope" class="form-label">Audit Scope</label>
                        <input type="text" class="form-control" id="scope" placeholder="Define your audit scope">
                        <div class="form-text">Optional: Define the scope of your audit</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="objectives" class="form-label">Audit Objectives</label>
                        <textarea class="form-control" id="objectives" rows="3" placeholder="Define your audit objectives"></textarea>
                        <div class="form-text">Optional: Describe what you're trying to achieve</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="permission" required>
                        <label class="form-check-label" for="permission">
                            I have permission to scan this network and understand the risks
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-play"></i> Start Network Scan
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Scan Tips -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb"></i> Scan Tips</h6>
            </div>
            <div class="card-body">
                <small>
                    <ul class="mb-0">
                        <li>Use /24 for typical home networks</li>
                        <li>Larger subnets may take longer to scan</li>
                        <li>Some hosts may not respond to ping</li>
                        <li>Firewalls may block discovery attempts</li>
                    </ul>
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Scan Results</h5>
                <div id="scanStats" class="badge bg-secondary">Ready</div>
            </div>
            <div class="card-body">
                <div id="resultsContainer" class="results-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>MAC Address</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-success" id="downloadPdfBtn">
                            <i class="fas fa-file-pdf"></i> Download PDF Report
                        </button>
                        <button class="btn btn-info" id="exportJsonBtn">
                            <i class="fas fa-file-code"></i> Export JSON
                        </button>
                    </div>
                </div>
                
                <div id="noResults" class="text-center text-muted py-5">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <h5>No scan results yet</h5>
                    <p>Configure your scan parameters and click "Start Network Scan" to begin.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let scanResults = [];

document.getElementById('networkScanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!document.getElementById('permission').checked) {
        showAlert('You must confirm you have permission before scanning.', 'danger');
        return;
    }
    
    const subnet = document.getElementById('subnet').value;
    const scope = document.getElementById('scope').value;
    const objectives = document.getElementById('objectives').value;
    
    // Show loading
    showLoading();
    document.getElementById('scanStats').textContent = 'Scanning...';
    document.getElementById('scanStats').className = 'badge bg-warning';
    
    fetch('/api/scan_network', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            subnet: subnet,
            scope: scope,
            objectives: objectives
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            scanResults = data.data;
            displayResults(data.data);
            document.getElementById('scanStats').textContent = `${data.data.length} hosts found`;
            document.getElementById('scanStats').className = 'badge bg-success';
        } else {
            showAlert('Scan failed: ' + data.error, 'danger');
            document.getElementById('scanStats').textContent = 'Scan failed';
            document.getElementById('scanStats').className = 'badge bg-danger';
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showAlert('Network error: ' + error.message, 'danger');
        document.getElementById('scanStats').textContent = 'Error';
        document.getElementById('scanStats').className = 'badge bg-danger';
    });
});

function displayResults(results) {
    const tbody = document.getElementById('resultsTableBody');
    tbody.innerHTML = '';
    
    if (results.length === 0) {
        document.getElementById('noResults').style.display = 'block';
        document.getElementById('resultsContainer').style.display = 'none';
        return;
    }
    
    document.getElementById('noResults').style.display = 'none';
    document.getElementById('resultsContainer').style.display = 'block';
    
    results.forEach(host => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${host.ip}</strong></td>
            <td><code>${host.mac}</code></td>
            <td><span class="badge bg-${host.status === 'up' ? 'success' : 'secondary'}">${host.status}</span></td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <a href="/port_scan?ip=${host.ip}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-door-open"></i> Port Scan
                    </a>
                    <a href="/os_detection?ip=${host.ip}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-desktop"></i> OS Detect
                    </a>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Download PDF Report
document.getElementById('downloadPdfBtn').addEventListener('click', function() {
    if (scanResults.length === 0) {
        showAlert('No results to download', 'warning');
        return;
    }
    
    const subnet = document.getElementById('subnet').value;
    const title = `Network Scan Report - ${subnet}`;
    const filename = `network_scan_${subnet.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.pdf`;
    
    downloadReport(scanResults, title, filename);
});

// Export JSON
document.getElementById('exportJsonBtn').addEventListener('click', function() {
    if (scanResults.length === 0) {
        showAlert('No results to export', 'warning');
        return;
    }
    
    const dataStr = JSON.stringify(scanResults, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `network_scan_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
});

// Pre-fill IP from URL parameters if available
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('subnet')) {
    document.getElementById('subnet').value = urlParams.get('subnet');
}
</script>
{% endblock %} 